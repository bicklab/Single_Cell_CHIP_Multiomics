---
title: "cellchat"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "~/Alyssa/Single_Cell_CHIP/")

library(Seurat)
library(tidyverse)

source("../scripts/image_formatting.R")
```

```{r}
devtools::install_github("sqjin/CellChat")
```

```{r}
library(CellChat)

# Generate Cell Chat Objects 
create_cc = function(seu_obj, nPatterns, output_path = "") {
  # creating cellchat object from steps of tutorial 
  cellchat = createCellChat(object = seu_obj, meta = seu_obj@meta.data, group.by = "cell_type") 
  cellchat@DB = CellChatDB.human
  #preprocessing
  cellchat = subsetData(cellchat)
  cellchat = identifyOverExpressedGenes(cellchat)
  cellchat = identifyOverExpressedInteractions(cellchat) # Identify over-expressed ligand-receptor interactions (pairs) within the used CellChatDB
  cellchat = projectData(cellchat, PPI.human) # A diffusion process is used to smooth genes’ expression values based on their neighbors’ defined in a high-confidence experimentally validated protein-protein network.
  cellchat = computeCommunProb(cellchat, type = 'truncatedMean', trim = 0.1) # calculating the average gene expression by discarding 10% from each end of the data 
  # Filter out the cell-cell communication if there are only few number of cells in certain cell groups
  cellchat = filterCommunication(cellchat, min.cells = 25) # Filter cell-cell communication if there are only few number of cells in certain cell groups
  cellchat = computeCommunProbPathway(cellchat) # Compute the communication probability on signaling pathway level by summarizing all related ligands/receptors
  cellchat = aggregateNet(cellchat) # Calculate the aggregated network by counting the number of links or summarizing the communication probability
  cellchat = netAnalysis_computeCentrality(cellchat, slot.name = "netP") # compute the network centrality scores allowing identification of dominant senders, receivers, mediators and influencers in all inferred communication networks 
  #outgoing patterns
  # selectK(cellchat, pattern = "outgoing") # ran before to determine best number for nPatterns 
  #cellchat = identifyCommunicationPatterns(cellchat, pattern = "outgoing", k = nPatterns)
  #incoming patterns
  # selectK(cellchat, pattern = "incoming")
  #cellchat = identifyCommunicationPatterns(cellchat, pattern = "incoming", k = nPatterns)
  if (output_path != "") {
    saveRDS(cellchat, output_path)
  }
  return(cellchat)
}

diet_seurat_trimmed = readRDS("rds_objects/diet_seurat_trimmed.rds")

diet_seurat_trimmed@meta.data$cell_type[diet_seurat_trimmed@meta.data$cell_type == "CD14 Monos"] = "CD14+ Monocytes"
diet_seurat_trimmed@meta.data$cell_type[diet_seurat_trimmed@meta.data$cell_type == "CD16 Monos"] = "CD16+ Monocytes"
diet_seurat_trimmed@meta.data$cell_type[diet_seurat_trimmed@meta.data$cell_type == "B"] = "B cells"
diet_seurat_trimmed@meta.data$cell_type[diet_seurat_trimmed@meta.data$cell_type == "NK"] = "NK cells"

veh_seurat_trimmed = subset(diet_seurat_trimmed, subset = STIM == "VEH")
veh_seurat_trimmed.list = SplitObject(veh_seurat_trimmed, split.by = c("MUTATION.GROUP"))

veh_seurat_trimmed_tet2 = veh_seurat_trimmed.list$TET2
veh_seurat_trimmed_dnmt3a = veh_seurat_trimmed.list$DNMT3A
veh_seurat_trimmed_control = veh_seurat_trimmed.list$none

veh_cc_tet2 = create_cc(veh_seurat_trimmed_tet2, 3, "rds_objects/veh_cc_control.rds")
veh_cc_dnmt3a = create_cc(veh_seurat_trimmed_dnmt3a, 3, "rds_objects/veh_cc_tet2.rds")
veh_cc_control = create_cc(veh_seurat_trimmed_control, 3, "rds_objects/veh_cc_dnmt3a.rds")

```


```{r}
veh_cc_control = readRDS("rds_objects/veh_cc_control.rds")
veh_cc_tet2 = readRDS("rds_objects/veh_cc_tet2.rds")
veh_cc_dnmt3a = readRDS("rds_objects/veh_cc_dnmt3a.rds")
```


```{r}
tet2_cc.list = list(TET2 = veh_cc_tet2, Control = veh_cc_control)
tet2_merged_cc = mergeCellChat(tet2_cc.list, add.names = names(tet2_cc.list))
tet2_merged_cc = updateCellChat(tet2_merged_cc)

dnmt3a_cc.list = list(DNMT3A = veh_cc_dnmt3a, Control = veh_cc_control)
dnmt3a_merged_cc = mergeCellChat(dnmt3a_cc.list, add.names = names(dnmt3a_cc.list))
dnmt3a_merged_cc = updateCellChat(dnmt3a_merged_cc)

all_cc.list = list(TET2 = veh_cc_tet2, DNMT3A = veh_cc_dnmt3a, Control = veh_cc_control)
all_merged_cc = mergeCellChat(all_cc.list, add.names = names(all_cc.list))
all_merged_cc = updateCellChat(all_merged_cc)
```

```{r}
(tet2_cd14_cc_bar = rankNet(tet2_merged_cc, mode = "comparison", comparison = c(1,2), sources.use = "CD14+ Monocytes", signaling = c("IL1", "IL6", "SELPLG", "ITGB2", "PECAM1", "MIF", "GALECTIN"), do.stat = TRUE))
(dnmt3a_cd14_cc_bar = rankNet(dnmt3a_merged_cc, mode = "comparison", comparison = c(1,2), sources.use = "CD14+ Monocytes", signaling = c("IL1", "IL6", "SELPLG", "ITGB2", "PECAM1", "MIF", "GALECTIN"), do.stat = TRUE))

# signaling = c("MIF", "GALECTIN", "ITGB2", "ICAM", "THBS", "TGFb"), 

rankNet(all_merged_cc, mode = "comparison", comparison = c(1,2,3), sources.use = "CD8+ T cells", signaling = "MIF")

signaling = c("IL1", "IL6", "SELPLG", "ITGB2", "PECAM1", "MIF", "GALECTIN")


```


```{r}
# Titles do not output

netVisual_diffInteraction(tet2_merged_cc, title.name = "TET2 CD14+ Monocytes Outgoing Differential Signaling", weight.scale = T, measure = "weight", sources.use = c("CD14+ Monocytes"), targets.use = c("CD8+ T cells", "CD4+ T cells", "B cells", "NK cells", "CD16+ Monocytes", "Dendritic cells", "Erythroid-like cells", "Platelets"), color.use = rep("grey", 9), color.edge = brewer.pal(4, "Paired")[c(4,2)])
netVisual_diffInteraction(dnmt3a_merged_cc, title.name = "DNMT3A CD14+ Monocytes Outgoing Differential Signaling",weight.scale = T, measure = "weight", sources.use = c("CD14+ Monocytes"), targets.use = c("CD8+ T cells", "CD4+ T cells", "B cells", "NK cells", "CD16+ Monocytes", "Dendritic cells", "Erythroid-like cells", "Platelets"), color.use = rep("grey", 9), color.edge = brewer.pal(4, "Paired")[c(4,2)])

netVisual_diffInteraction(tet2_merged_cc, title.name = "TET2 CD4+ T Cells Outgoing Differential Signaling", weight.scale = T, measure = "weight", sources.use = c("CD4+ T cells"), targets.use = c("CD8+ T cells", "CD14+ Monocytes", "B cells", "NK cells", "CD16+ Monocytes", "Dendritic cells", "Erythroid-like cells", "Platelets"), color.use = rep("grey", 9), color.edge = brewer.pal(4, "Paired")[c(4,2)])
netVisual_diffInteraction(dnmt3a_merged_cc, title.name = "DNMT3A CD4+ T Cells Outgoing Differential Signaling", weight.scale = T, measure = "weight", sources.use = c("CD4+ T cells"), targets.use = c("CD8+ T cells", "CD14+ Monocytes", "B cells", "NK cells", "CD16+ Monocytes", "Dendritic cells", "Erythroid-like cells", "Platelets"), color.use = rep("grey", 9), color.edge = brewer.pal(4, "Paired")[c(4,2)])

```

