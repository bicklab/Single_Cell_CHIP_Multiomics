---
title: "metacell"
output: html_document
date: '2023-04-10'
---

```{r setup}
knitr::opts_knit$set(root.dir = "~/Alyssa/Single_Cell_CHIP/")

library(tidyverse)
library(Seurat)
library(DropletUtils)
library(Matrix)
```

# Trim excessive data and clear remaining doublets.
```{r}
#diet_seurat = DietSeurat(scaled_filtered_annotated_seurat, assays = "RNA")
#saveRDS(diet_seurat, "rds_objects/diet_seurat.rds")

# need some more stringent removal of doublets for one lane
pANN_frame = read_tsv("input_data/pANN_frame.tsv") %>% as.data.frame()
rownames(pANN_frame) = pANN_frame$cell_ID
diet_seurat_trimmed = AddMetaData(diet_seurat, pANN_frame)

cells_to_remove = diet_seurat_trimmed@meta.data %>%
  filter(LANE == "7079-3") %>%
  filter(pANN >= 0.28) %>%
  pull(cell_ID)

diet_seurat_trimmed = diet_seurat_trimmed[,!colnames(diet_seurat_trimmed) %in% cells_to_remove]
saveRDS(diet_seurat_trimmed, "rds_objects/diet_seurat_trimmed.rds")

```

```{r}
# save files (followed explanation here: https://www.biomage.net/blog/how-to-demultiplex-a-seurat-object-and-convert-it-to-10x-files)
diet_seurat_trimmed = readRDS("rds_objects/diet_seurat_trimmed.rds")

DefaultAssay(diet_seurat_trimmed) <- "RNA"
counts = diet_seurat_trimmed[["RNA"]]@data

demultiplex_convert_to_10x = function(obj, samples) { 
    for (i in 1:length(samples)) {
      print(paste0("Converting sample ", samples[i]))
      obj.sub = obj[[samples[i]]]
      DropletUtils::write10xCounts(path = paste0(getwd(),"/demultiplexed_cell_types/",samples[i]), x = obj.sub[["RNA"]]@data, type = "sparse", version="3")
      }
}



```


# Split and save by CHIP/control.
```{r}
diet_seurat_trimmed@meta.data$Cell_Type_Group = paste(diet_seurat_trimmed@meta.data$cell_type, diet_seurat_trimmed@meta.data$GROUP)
diet_seurat_trimmed.list = Seurat::SplitObject(diet_seurat_trimmed, split.by = "Cell_Type_Group")
sample.names = unique(diet_seurat_trimmed$Cell_Type_Group)

demultiplex_convert_to_10x(obj = diet_seurat_trimmed.list, samples = sample.names)

```

# Split and save by CHIP/CCUS/control and cell types.
```{r}
# Function for demultiplexing and saving in CCUS folder.
demultiplex_convert_to_10x = function(obj, samples) { 
    if(!dir.exists(file.path(getwd(), "ccus_demultiplexed"))) {
      dir.create(file.path(getwd(), "ccus_demultiplexed"))
    }
    for (i in 1:length(samples)) {
      print(paste0("Converting sample ", samples[i]))
      obj.sub = obj[[samples[i]]]
      DropletUtils::write10xCounts(path = paste0(getwd(),"/ccus_demultiplexed_cell_types/",samples[i]), x = obj.sub[["RNA"]]@data, type = "sparse", version="3")
      }
}

# Add CCUS labels.
diet_seurat_trimmed@meta.data$CCUS = "Control"
diet_seurat_trimmed@meta.data$CCUS[diet_seurat_trimmed@meta.data$CHIP == "chip"] = "CHIP"
diet_seurat_trimmed@meta.data$CCUS[diet_seurat_trimmed@meta.data$CHIVEID %in% c("CH-20-004", "CH-21-014", "CH-21-073")] = "CCUS"

# Create CCUS cell type group labels.
diet_seurat_trimmed@meta.data$Cell_Type_Group = paste(diet_seurat_trimmed@meta.data$cell_type, diet_seurat_trimmed@meta.data$MUTATION.GROUP, diet_seurat_trimmed@meta.data$CCUS, diet_seurat_trimmed@meta.data$STIM, sep = "_")

# Split and save.
diet_seurat_trimmed.list = Seurat::SplitObject(diet_seurat_trimmed, split.by = "Cell_Type_Group")
sample.names = names(diet_seurat_trimmed.list)
rm(diet_seurat_trimmed)
gc()
demultiplex_convert_to_10x(obj = diet_seurat_trimmed.list, samples = sample.names)
```



# We attempted metacells2 for mutated/wt cells but there were not enough cells to have power for comparison.
```{r}
dnmt3a_mutant_seu = readRDS("rds_objects/DNMT3Amutant_seu.rds")

DefaultAssay(dnmt3a_mutant_seu) = "RNA"
dnmt3a_mutant_seu@meta.data$CLONE = paste0("DNMT3A_", dnmt3a_mutant_seu@meta.data$CLONE, "_", gsub(" ", "_", dnmt3a_mutant_seu@meta.data$cell_type))

dnmt3a_mutant_seu.list = Seurat::SplitObject(dnmt3a_mutant_seu, split.by = "CLONE")
sample.names = unique(dnmt3a_mutant_seu$CLONE)

demultiplex_convert_to_10x(obj = dnmt3a_mutant_seu.list, samples = sample.names)

```

```{r}
tet2_mutant_seu = readRDS("rds_objects/TET2mutant_seu.rds")

DefaultAssay(tet2_mutant_seu) = "RNA"
tet2_mutant_seu@meta.data$CLONE = paste0("TET2_", tet2_mutant_seu@meta.data$CLONE, "_", gsub(" ", "_", tet2_mutant_seu@meta.data$cell_type))

tet2_mutant_seu.list = Seurat::SplitObject(tet2_mutant_seu, split.by = "CLONE")
sample.names = unique(tet2_mutant_seu$CLONE)

demultiplex_convert_to_10x(obj = tet2_mutant_seu.list, samples = sample.names)

```
