---
title: "metacells2"
output: html_document
date: "2023-09-25"
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "~/Alyssa/Single_Cell_CHIP/")

library(tidyverse)
library(Seurat)
library(DESeq2)
library(SingleCellExperiment)
library(scuttle)
library(apeglm)
```

# Trim excessive data and clear remaining doublets.
```{r}
#diet_seurat = DietSeurat(scaled_filtered_annotated_seurat, assays = "RNA")
#saveRDS(diet_seurat, "rds_objects/diet_seurat.rds")

# need some more stringent removal of doublets for one lane
pANN_frame = read_tsv("input_data/pANN_frame.tsv") %>% as.data.frame()
rownames(pANN_frame) = pANN_frame$cell_ID
diet_seurat_trimmed = AddMetaData(diet_seurat, pANN_frame)

cells_to_remove = diet_seurat_trimmed@meta.data %>%
  filter(LANE == "7079-3") %>%
  filter(pANN >= 0.28) %>%
  pull(cell_ID)

diet_seurat_trimmed = diet_seurat_trimmed[,!colnames(diet_seurat_trimmed) %in% cells_to_remove]
saveRDS(diet_seurat_trimmed, "rds_objects/diet_seurat_trimmed.rds")

```

# Get counts.
```{r}
diet_seurat_trimmed = readRDS("rds_objects/diet_seurat_trimmed.rds")
counts = diet_seurat_trimmed@assays$RNA
```

# Functions for differential expression.
```{r}
clump = function(agg_sce, label1, label2, cell_type) {
    agg_sce = agg_sce[, agg_sce$GROUP %in% c(label1, label2)] # Subset on group of interest.

    metadata = colData(agg_sce)[,c("GROUP", "metacell")]
    metadata$CHIP = factor(metadata$GROUP, levels = c(label2, label1)) # Establish to get the order we want.
    
    dds = DESeqDataSetFromMatrix(round(assay(agg_sce, "counts")), 
                    colData = metadata, 
                    design = ~ GROUP)
    
    smallest_group_sample_size = min(sum(metadata$CHIP == label1), sum(metadata$CHIP == label2))
    
    keep = rowSums(counts(dds) >= 10) >= nrow(metadata) * 0.85 # 10 # at least 10 metacells that have at least 10 transcripts
    dds = dds[keep,]
    dds = DESeq(dds)
    
    res = results(dds, contrast = c("GROUP", label1, label2))

    summary(res)
    res_ordered_wald = res[order(res$padj),] %>%
      as.data.frame() %>%
      filter(!is.na(padj)) %>%
      rownames_to_column("gene")
    
    # Remove hemoglobin and X biased genes.
    remove_list = c("DDX3Y", "HBB", "HBA1", "HBD", "HBZ", "HBG2", "HBG1", "HBG2", "CYB5R3", "HBE1", "HBM", "HBQ1", "XIST", "UTY", "USP9Y", res_ordered_wald$gene[grep("MRP", res_ordered_wald$gene)])
    
    filtered_data = res_ordered_wald %>%
      filter(!gene %in% remove_list)
  
    write_tsv(filtered_data, paste0("tables/metacells_de_cell_types/", cell_type, "_", label1, "_vs_", label2, ".tsv"))
    return(filtered_data)
}


get_cell_type_data_for_clumping = function(cell_type_name) {
  lower_cell_type_name = gsub(" ", "_", tolower(cell_type_name))
  dnmt3a_cell_type_metadata = read_csv(paste0("metacells_files/", lower_cell_type_name, "_dnmt3a_veh_metacells.csv")) %>%
    mutate(GROUP = "DNMT3A")
  tet2_cell_type_metadata = read_csv(paste0("metacells_files/", lower_cell_type_name, "_tet2_veh_metacells.csv")) %>%
    mutate(GROUP = "TET2")
  control_cell_type_metadata = read_csv(paste0("metacells_files/", lower_cell_type_name, "_none_veh_metacells.csv")) %>%
    mutate(GROUP = "none")
  cell_type_metadata = rbind(dnmt3a_cell_type_metadata, tet2_cell_type_metadata, control_cell_type_metadata) %>%
    dplyr::rename(Cell_ID = `...1`) %>%
    filter(metacell >= 0) %>% # negative metacell assignments given to outliers
    filter(Cell_ID %in% colnames(counts@counts))
    
  cell_type_counts = counts@counts[,cell_type_metadata$Cell_ID] # this syntax changes for seurat v4 and seurat v5 (counts vs counts@counts)
  rownames(cell_type_metadata) = cell_type_metadata$Cell_ID

  cell_type_sce = SingleCellExperiment(cell_type_counts, colData = cell_type_metadata)
  assayNames(cell_type_sce) = "counts"

  cell_type_agg_sce = aggregateAcrossCells(cell_type_sce, ids = colData(cell_type_sce)[,c("GROUP", "metacell")])
  return(cell_type_agg_sce)
}


```


# Run differential expression.
```{r}
run_chip_comparisons = function(cell_type_name) {

  agg_cell_type_data = get_cell_type_data_for_clumping(cell_type_name)

  tryCatch({
    tet2_comparison = clump(agg_cell_type_data, label1 = "TET2", label2 = "none", cell_type = cell_type_name) 
  }, error = function(cond) {
    message("TET2 comparison failed.")
  })
  tryCatch({
    dnmt3a_comparison = clump(agg_cell_type_data, label1 = "DNMT3A", label2 = "none", cell_type = cell_type_name) 
  }, error = function(cond) {
    message("DNMT3A comparison failed.")
  })
}

cell_types = c("CD14 Monos", "CD8+ T cells", "CD4+ T cells")
lapply(cell_types, run_chip_comparisons)

```