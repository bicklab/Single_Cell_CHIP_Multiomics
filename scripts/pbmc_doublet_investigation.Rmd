---
title: "PBMC doublet investigation"
output: html_document
---

```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = "~/Alyssa/SC_CHIP_HIV_Diabetes/")
```


Load PBMC data before QC filters are applied (they will filter out some of our doublets).

```{r}
jh1_preprocessed = readRDS("rds_objects/preprocessed/8032_JH1.rds")
jh2_preprocessed = readRDS("rds_objects/preprocessed/8032_JH2.rds")

seurat_list = list(jh1_preprocessed, jh2_preprocessed)

```

RUN DOUBLET FINDER

```{r}
library(Seurat)
library(DoubletFinder)
library(tidyverse)

run_doubletfinder = function(seurat_object) {
  
  Idents(seurat_object) = "HTO_classification.global"
  seurat_object = subset(seurat_object, idents = "Negative", invert = T) # remove cells without HTO
  PCs = 1:15 # number of PCs to use determined by looking at ElbowPlot(seurat_object)
  
  sweep_res_list = paramSweep_v3(seurat_object, PCs = PCs, sct = TRUE)
  gt_calls = seurat_object@meta.data[rownames(sweep_res_list[[1]]), "HTO_classification.global"] # ground truth (assuming HTO worked properly)
  sweep_stats = summarizeSweep(sweep_res_list, GT = TRUE, GT.calls = gt_calls)
  bcmvn = find.pK(sweep_stats)
  
  pK = bcmvn$pK[which.max(bcmvn$BCmetric)]
  pK = as.numeric(levels(pK))[pK]
  
  annotations = seurat_object@meta.data$seurat_clusters
  homotypic.prop = modelHomotypic(annotations)
  doublet_rate = (dim(seurat_object)[2]/0.57) * 4.6e-6 # based on info from https://satijalab.org/costpercell/
  nExp_poi = round(doublet_rate*nrow(seurat_object@meta.data))
  nExp_poi.adj = round(nExp_poi*(1-homotypic.prop))
  
  seurat_object = doubletFinder_v3(seurat_object, PCs = PCs, pN = 0.25, pK = pK, nExp = nExp_poi.adj, reuse.pANN = FALSE, sct = TRUE)
  
  doublet_finder_name = colnames(seurat_object@meta.data)[str_detect(string = colnames(seurat_object@meta.data), pattern = "DF.classifications*")] 
  seurat_object[["DoubletFinder"]] = seurat_object[[doublet_finder_name]] # make doublet finder column more identifiable
  seurat_object[[doublet_finder_name]] = NULL
  
  pANN_name = colnames(seurat_object@meta.data)[str_detect(string = colnames(seurat_object@meta.data), pattern = "pANN")] 
  seurat_object[["pANN"]] = seurat_object[[pANN_name]] # make pANN column more identifiable
  seurat_object[[pANN_name]] = NULL
  
  return(seurat_object)
}

seurat_list = lapply(seurat_list, run_doubletfinder)
```
```{r}
saveRDS(seurat_list, "rds_objects/doublet_testing_seurat_list.rds")
```

MERGE DATA AND SEPARATE INTO DOUBLETS AND SINGLETS

```{r}
library(Seurat)
seurat_list = readRDS("rds_objects/doublet_testing_seurat_list.rds")
merged_data = merge(seurat_list[[1]], y = seurat_list[[2]], add.cell.ids = c("8032_JH1","8032_JH2"), merge.data = TRUE, merge.dr = c("umap")) # merge.data = TRUE preserves normalization from before

Idents(merged_data) = "DoubletFinder"
DefaultAssay(merged_data) = "RNA"
doublets = subset(merged_data, subset = DoubletFinder == "Doublet" & HTO_classification.global == "Singlet") # only want the ones that were connected to each other within a sample because they are biologically connected rather than artifactually connected
singlets = subset(merged_data, subset = DoubletFinder == "Singlet" & HTO_classification.global == "Singlet")
```

REMOVE MITO AND RIBO GENES

```{r}
filter_mt_rp = function(seu) {
  rp.ch = rownames(seu)[grepl("^RPS|^RPL", rownames(seu))]
  mt.ch = rownames(seu)[grepl("^MT-", rownames(seu))]
  seu = subset(seu, features = setdiff(rownames(seu), rp.ch))
  seu = subset(seu, features = setdiff(rownames(seu), mt.ch))
  return(seu)
}
doublets = filter_mt_rp(doublets)
singlets = filter_mt_rp(singlets)
```

ADD CHIP STATUS

```{r}
add_chip = function(pbmc_collapsed) {
  pbmc_collapsed@meta.data$Lane = substr(rownames(pbmc_collapsed@meta.data), 1, 8)
  pbmc_collapsed@meta.data$Sample = paste(pbmc_collapsed@meta.data$Lane, pbmc_collapsed@meta.data$HTO_classification, sep = "_")

  index = c("8032_JH1_sample-1", "8032_JH1_sample-2", "8032_JH1_sample-3", "8032_JH1_sample-4", "8032_JH1_sample-5", "8032_JH1_sample-6",
          "8032_JH2_sample-1", "8032_JH2_sample-2", "8032_JH2_sample-3", "8032_JH2_sample-4", "8032_JH2_sample-5", "8032_JH2_sample-6")
  values = c("5008", "5010", "1147", "5016", "5037", "2113",
           "5020", "5034", "5022", "5021", "5004", "5001")
  pbmc_collapsed@meta.data$HATIM_ID = values[match(pbmc_collapsed@meta.data$Sample, index)]

  index = c("5008", "5010", "1147", "5016", "5037", "2113", "5020", "5034", "5022", "5021", "5004", "5001")
  values = c("CHIP", "CHIP", "CHIP", "Control", "Control", "Control", "Control", "Control", "Control", "CHIP", "CHIP", "CHIP")
  pbmc_collapsed@meta.data$Mutation_Group = values[match(pbmc_collapsed@meta.data$HATIM_ID, index)]
  return(pbmc_collapsed)
}

chip_labeled_doublets = add_chip(doublets)
chip_labeled_singlets = add_chip(singlets)
```

USE AZIMUTH TO LABEL SINGLETS FOR CLUSTERING COMPARISONS

```{r}
library(Azimuth)

# label singlets
annotated_singlets = RunAzimuth(chip_labeled_singlets, reference = "pbmcref")

```

```{r}
library(Seurat) 
library(tidyverse)

# sample some CD14 Mono and CD8 TEM singlets
cd14s = subset(annotated_singlets, subset = predicted.celltype.l2 == "CD14 Mono")
cd8_tems = subset(annotated_singlets, subset = predicted.celltype.l2 == "CD8 TEM")
cd4_tcms = subset(annotated_singlets, subset = predicted.celltype.l2 == "CD4 TCM")
dcs = subset(annotated_singlets, subset = predicted.celltype.l2 %in% c("cDC1", "cDC2", "pDC"))


n_cells_to_sample = 1000

# cluster artificial doublets with true doublets
get_sample_data = function(celltype_data, n_cells_to_sample = 1000) {
  cell_cols = colnames(GetAssayData(celltype_data))
  celltype_subset = GetAssayData(object = celltype_data, slot = "counts")[, cell_cols]
  celltype_subset_cols = sample(colnames(celltype_subset), n_cells_to_sample, replace = TRUE)
  celltype_data_to_use = celltype_subset[, celltype_subset_cols]
  return(celltype_data_to_use)
}

cd14_data = get_sample_data(cd14s)
cd8_data = get_sample_data(cd8_tems)
cd4_data = get_sample_data(cd4_tcms)
dc_data = get_sample_data(dcs)

get_fake_doublets = function(celltype_data_1, celltype_data_2, label = "X", starting_index = 0) {
  fake_doublets = (celltype_data_1 + celltype_data_2)
  colnames(fake_doublets) <- paste0(label, (1 + starting_index):(ncol(fake_doublets) + starting_index))
  return(fake_doublets)
}

fake_cd14_cd8_doublets = get_fake_doublets(cd14_data, cd8_data, label = "CD14_CD8_")
fake_cd14_cd4_doublets = get_fake_doublets(cd14_data, cd4_data, label = "CD14_CD4_")
fake_dc_cd8_doublets = get_fake_doublets(dc_data, cd8_data, label = "DC_CD8_")
fake_dc_cd4_doublets = get_fake_doublets(dc_data, cd4_data, label = "DC_CD4_")

real_doublets = GetAssayData(object = chip_labeled_doublets, slot = "counts")

fake_doublets = cbind(fake_cd14_cd8_doublets, fake_cd14_cd4_doublets, fake_dc_cd8_doublets, fake_dc_cd4_doublets)

combined_doublets = cbind(fake_doublets, real_doublets)
seurat_doublets = CreateSeuratObject(combined_doublets)

seurat_doublets = Seurat::NormalizeData(seurat_doublets) %>%
  Seurat::FindVariableFeatures() %>%
  Seurat::ScaleData()
seurat_doublets = RunPCA(seurat_doublets, pc.genes = seurat_doublets@var.genes, pcs.print = 0) %>%
  RunUMAP(dims = 1:15) %>%
  FindNeighbors(return.neighbor = TRUE, k.param = 50)

neighbor_indices = seurat_doublets@neighbors$RNA.nn@nn.idx
neighbor_key = rownames(seurat_doublets@meta.data)

neighbor_data = neighbor_indices
for (i in 1:nrow(neighbor_indices)) {
  for (j in 1:ncol(neighbor_indices)) {
    neighbor_data[i,j] = neighbor_key[neighbor_indices[i,j]]
  }
}

seurat_doublets@meta.data$Group = c(rep("CD14_CD8", times = n_cells_to_sample), rep("CD14_CD4", times = n_cells_to_sample), rep("DC_CD8", times = n_cells_to_sample), rep("DC_CD4", times = n_cells_to_sample), rep("Real", times = ncol(real_doublets)))
DimPlot(seurat_doublets, group.by = "Group", order = c("Real"))

seurat_doublets@meta.data %>%
  group_by(Group) %>%
  summarise(avg_count = median(nCount_RNA), avg_feature = median(nFeature_RNA))

cell_names = rownames(seurat_doublets@meta.data)
n_cells = length(cell_names)
pca_coord = seurat_doublets@reductions$pca@cell.embeddings
#rm(seurat_doublets) ## Free-up memory
#gc() ## Free-up memory
dist_mat = fields::rdist(pca_coord)
colnames(dist_mat) = cell_names
rownames(dist_mat) = cell_names



    
# count neighbors of true doublets - if clustering near artificial doublets, likely CD14 Mono/CD8 TEM pairs -> of interest
```



TRY WITH LARGER GROUPING CATEGORIES

```{r}
library(Seurat) 
library(tidyverse)

set.seed(123)

# sample some CD14 Mono and CD8 TEM singlets
monos = subset(annotated_singlets, subset = predicted.celltype.l1 == "Mono")
cd8s = subset(annotated_singlets, subset = predicted.celltype.l1 == "CD8 T")
cd4s = subset(annotated_singlets, subset = predicted.celltype.l1 == "CD4 T")
nks = subset(annotated_singlets, subset = predicted.celltype.l1 == "NK")
dcs = subset(annotated_singlets, subset = predicted.celltype.l1 == "DC")
bs = subset(annotated_singlets, subset = predicted.celltype.l1 == "B")

n_cells_to_sample = 1000

# cluster artificial doublets with true doublets
get_sample_data = function(celltype_data, n_cells_to_sample = 1000) {
  cell_cols = colnames(GetAssayData(celltype_data))
  celltype_subset = GetAssayData(object = celltype_data, slot = "counts")[, cell_cols]
  celltype_subset_cols = sample(colnames(celltype_subset), n_cells_to_sample, replace = TRUE)
  celltype_data_to_use = celltype_subset[, celltype_subset_cols]
  return(celltype_data_to_use)
}

mono_data = get_sample_data(monos)
cd8_data = get_sample_data(cd8s)
cd4_data = get_sample_data(cd4s)
nk_data = get_sample_data(nks)
dc_data = get_sample_data(dcs)
b_data = get_sample_data(bs)

get_fake_doublets = function(celltype_data_1, celltype_data_2, label = "X", starting_index = 0) {
  fake_doublets = (celltype_data_1 + celltype_data_2)
  colnames(fake_doublets) <- paste0(label, (1 + starting_index):(ncol(fake_doublets) + starting_index))
  return(fake_doublets)
}


fake_mono_cd8_doublets = get_fake_doublets(mono_data, cd8_data, label = "Mono_CD8_")
fake_mono_cd4_doublets = get_fake_doublets(mono_data, cd4_data, label = "Mono_CD4_")
fake_mono_nk_doublets = get_fake_doublets(mono_data, nk_data, label = "Mono_NK_")
fake_mono_dc_doublets = get_fake_doublets(mono_data, dc_data, label = "Mono_DC_")
fake_mono_b_doublets = get_fake_doublets(mono_data, b_data, label = "Mono_B_")

fake_cd8_cd4_doublets = get_fake_doublets(cd8_data, cd4_data, label = "CD8_CD4_")
fake_cd8_nk_doublets = get_fake_doublets(cd8_data, nk_data, label = "CD8_NK_")
fake_cd8_dc_doublets = get_fake_doublets(cd8_data, dc_data, label = "CD8_DC_")
fake_cd8_b_doublets = get_fake_doublets(cd8_data, b_data, label = "CD8_B_")

fake_cd4_nk_doublets = get_fake_doublets(cd4_data, nk_data, label = "CD4_NK_")
fake_cd4_dc_doublets = get_fake_doublets(cd4_data, dc_data, label = "CD4_DC_")
fake_cd4_b_doublets = get_fake_doublets(cd4_data, b_data, label = "CD4_B_")

fake_nk_dc_doublets = get_fake_doublets(nk_data, dc_data, label = "NK_DC_")
fake_nk_b_doublets = get_fake_doublets(nk_data, b_data, label = "NK_B_")

fake_dc_b_doublets = get_fake_doublets(dc_data, b_data, label = "DC_B_")

fake_doublets = cbind(fake_mono_cd8_doublets, fake_mono_cd4_doublets, fake_mono_nk_doublets, fake_mono_dc_doublets, fake_mono_b_doublets, fake_cd8_cd4_doublets, fake_cd8_nk_doublets, fake_cd8_dc_doublets, fake_cd8_b_doublets, fake_cd4_nk_doublets, fake_cd4_dc_doublets, fake_cd4_b_doublets, fake_nk_dc_doublets, fake_nk_b_doublets, fake_dc_b_doublets)
real_doublets = GetAssayData(object = chip_labeled_doublets, slot = "counts")


combined_doublets = cbind(fake_doublets, real_doublets)
seurat_doublets = CreateSeuratObject(combined_doublets)

seurat_doublets = Seurat::NormalizeData(seurat_doublets) %>%
  Seurat::FindVariableFeatures() %>%
  Seurat::ScaleData()
seurat_doublets = RunPCA(seurat_doublets, pc.genes = seurat_doublets@var.genes) %>%
  RunUMAP(dims = 1:10, reduction = "pca") %>%
  FindNeighbors() %>%
  FindClusters(resolution = 0.5)


##can return neighbors or clusters (not both in the way i'm doing it)
# neighbor_indices = seurat_doublets@neighbors$RNA.nn@nn.idx
# neighbor_key = rownames(seurat_doublets@meta.data)

# neighbor_data = neighbor_indices
# for (i in 1:nrow(neighbor_indices)) {
#   for (j in 1:ncol(neighbor_indices)) {
#     neighbor_data[i,j] = neighbor_key[neighbor_indices[i,j]]
#   }
# }

seurat_doublets@meta.data$Group = c(rep("Mono_CD8", times = n_cells_to_sample), rep("Mono_CD4", times = n_cells_to_sample), rep("Mono_NK", times = n_cells_to_sample), rep("Mono_DC", times = n_cells_to_sample), rep("Mono_B", times = n_cells_to_sample), rep("CD8_CD4", times = n_cells_to_sample), rep("CD8_NK", times = n_cells_to_sample), rep("CD8_DC", times = n_cells_to_sample), rep("CD8_B", times = n_cells_to_sample), rep("CD4_NK", times = n_cells_to_sample), rep("CD4_DC", times = n_cells_to_sample), rep("CD4_B", times = n_cells_to_sample), rep("NK_DC", times = n_cells_to_sample), rep("NK_B", times = n_cells_to_sample), rep("DC_B", times = n_cells_to_sample), rep("Real", times = ncol(real_doublets)))

library(wesanderson)
(doublets_on_top = DimPlot(seurat_doublets, group.by = "Group", order = c("Real"), cols = c(wes_palette("Zissou1", 15, "continuous"), "black")))
(doublets_on_bottom = DimPlot(seurat_doublets, group.by = "Group", order = c("Mono_CD8", "Mono_CD4", "Mono_NK", "Mono_DC", "Mono_B", "CD8_CD4", "CD8_NK", "CD8_DC", "CD8_B", "CD4_NK", "CD4_DC", "CD4_B", "NK_DC", "NK_B", "DC_B", "Real"), cols = c("black", wes_palette("Zissou1", 15, "continuous"))))


seurat_doublets@meta.data %>%
  group_by(Group) %>%
  summarise(avg_count = median(nCount_RNA), avg_feature = median(nFeature_RNA))

table(seurat_doublets@meta.data$Group, seurat_doublets@meta.data$seurat_clusters)

(cluster_labeled = DimPlot(seurat_doublets, group.by = "seurat_clusters", order = c("Real"), cols = c(wes_palette("Zissou1", 21, "continuous"), "black"), label = TRUE))

directory = "~/Alyssa/SC_CHIP_HIV_Diabetes/"
save_plot = function(file, plot, legend = TRUE, width = 4, height = 4, png = FALSE) {
  if (png) { ggsave(plot = plot, filename =  paste0(file, ".png"), dpi = 600, width = ifelse(legend, width, width - 1.5), height = height, units = 'in') }
  ggsave(plot = plot, filename =  paste0(directory, file, ".pdf"), dpi = 600, width = ifelse(legend, width, width - 1.5), height = height, units = 'in')
}

save_plot("figures/umaps/doublets_real_on_top", doublets_on_top, width = 6)
save_plot("figures/umaps/doublets_real_on_bottom", doublets_on_bottom, width = 6)

#saveRDS(seurat_doublets, "rds_objects/doublet_testing_seurat_doublets.rds")
#saveRDS(annotated_singlets, "rds_objects/doublet_testing_annotated_singlets.rds")
# count neighbors of true doublets - if clustering near artificial doublets, likely CD14 Mono/CD8 TEM pairs -> of interest
```

```{r}
(cd3d_expression = FeaturePlot(seurat_doublets, features = "CD3D"))
(cd14_expression = FeaturePlot(seurat_doublets, features = "CD14"))

save_plot("figures/umaps/cd3d_expression", cd3d_expression, width = 6)
save_plot("figures/umaps/cd14_expression", cd14_expression, width = 6)

```
DIFEERENTIAL EXPRESSION ANALYSIS BETWEEN TRUE DOUBLET CLUSTER AND ARTIFICIAL CD14+CD8 CLUSTER
```{r}
BiocManager::install(c("edgeR", "DESeq2", "limma"))
devtools::install_github("neurorestore/Libra")
install.packages("TMB", type = "source")
library(Libra)

View(seurat_doublets@meta.data)
mono_cd8_doublets_real_and_fake = subset(seurat_doublets, subset = ((Group == "Mono_CD8" & seurat_clusters == "7") | (seurat_clusters == "2" & Group == "Real")))
View(mono_cd8_doublets_real_and_fake@meta.data)
mono_cd8_doublets_real_and_fake@meta.data$cell_type = "doublet"
# need groups here to split into pseudo replicates
mono_cd8_doublets_real_and_fake@meta.data$replicate = sample(1:5, nrow(mono_cd8_doublets_real_and_fake@meta.data), replace = TRUE) #rbinom(nrow(mono_cd8_doublets_real_and_fake@meta.data), 1, 0.5)
mono_cd8_doublets_real_and_fake@meta.data$label = mono_cd8_doublets_real_and_fake@meta.data$Group

de_results = run_de(mono_cd8_doublets_real_and_fake)


```
CODE FROM PAWAN FOR PSEUDOBULK BELOW
```{r}
run_pseudobulk <- function(data, stim_status){
    #Assign each cell randomly to a group 
    data@meta.data$split = rbinom(ncol(data), 1, 0.5)
    data@meta.data$sample_id = paste0(data@meta.data$Clone,'_',veh_data@meta.data$split)
    

    data = as.SingleCellExperiment(data)
    data = prepSCE(data, 
                  kid = "celltype.de", # subpopulation assignments
                  gid = "Clone",  # group IDs (Mutant/Wildtype)
                  sid = "sample_id",   # sample IDs (Mutant/Wildtype_0/1)
                  drop = TRUE)  # drop all other colData columns
    
    
    #generate sum of counts
    agg = aggregateData(
            data,
            assay = "counts",
            by = "sample_id",
            fun = "sum",
            scale = FALSE,
            verbose = TRUE,
            BPPARAM = SerialParam(progressbar = verbose)
    )
    
    # run pseudobulk (aggregation-based) DS analysis
    
    res = pbDS(agg, method = "DESeq2", verbose = FALSE)
    #data clean up
    tbl = res$table[[1]]
    
    # Save output
    filename = paste0(output_dir, "unstim", gsub(" ", "_", cell_type), "_", patient, "_", method, ".csv")
    write_csv(tbl[[1]], file = filename)
    
}
```

