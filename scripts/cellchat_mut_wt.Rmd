---
title: "cellchat"
output: html_document
---

```{r setup}
knitr::opts_knit$set(root.dir = "~/Alyssa/Single_Cell_CHIP/")

library(Seurat)
library(tidyverse)
library(CellChat)
library(RColorBrewer)

source("../scripts/image_formatting.R")

```

# Load object with mutant and wildtype labels.
```{r}
clean_with_clones = readRDS("../SC_CHIP_HIV_Diabetes/input_data/seurat_with_clones_PB_10.16.23.rds")
clean_with_clones$Clone[is.na(clean_with_clones$Clone)] = "Unassigned"
```

# Generate cellchat objects.
```{r}
create_cc = function(seu_obj, nPatterns = 3, output_path = "", group_by = "cell_type") {

  cellchat = createCellChat(object = seu_obj, meta = seu_obj@meta.data, group.by = group_by) 
  cellchat@DB = CellChatDB.human

  cellchat = subsetData(cellchat)
  cellchat = identifyOverExpressedGenes(cellchat)
  cellchat = identifyOverExpressedInteractions(cellchat)
  cellchat = projectData(cellchat, PPI.human) 
  cellchat = computeCommunProb(cellchat, type = 'truncatedMean', trim = 0.1) 
 
  cellchat = filterCommunication(cellchat, min.cells = 25) 
  cellchat = computeCommunProbPathway(cellchat) 
  cellchat = aggregateNet(cellchat) 
  cellchat = netAnalysis_computeCentrality(cellchat, slot.name = "netP") 
  
  if (output_path != "") {
    saveRDS(cellchat, output_path)
  }
  return(cellchat)
}


clean_with_clones@meta.data$cell_type[clean_with_clones@meta.data$cell_type == "CD14 Monos"] = "CD14+ Monocytes"
clean_with_clones@meta.data$cell_type[clean_with_clones@meta.data$cell_type == "CD16 Monos"] = "CD16+ Monocytes"
clean_with_clones@meta.data$cell_type[clean_with_clones@meta.data$cell_type == "B"] = "B cells"
clean_with_clones@meta.data$cell_type[clean_with_clones@meta.data$cell_type == "NK"] = "NK cells"
clean_with_clones@meta.data$cell_type[clean_with_clones@meta.data$cell_type == "CD14+ Monocytes" & clean_with_clones@meta.data$fake_monos == "fake"] = "Uncertain Monocytes"

# Subset to only vehicle cells.
veh_clones_trimmed = subset(clean_with_clones, subset = STIM == "VEH")

# Split object by mutation, cell type, and genotype. 
veh_complete_mut.list = SplitObject(veh_clones_trimmed, split.by = "MUTATION.GROUP")

veh_complete_tet2_mut = veh_complete_mut.list$TET2
veh_complete_dnmt3a_mut = veh_complete_mut.list$DNMT3A
veh_complete_control = veh_complete_mut.list$none

veh_complete_tet2_mut$cell_type[veh_complete_tet2_mut$cell_type == "CD14+ Monocytes" & veh_complete_tet2_mut$Clone != "Mutant"] = "Nonmutant CD14+ Monocytes"
veh_complete_dnmt3a_mut$cell_type[veh_complete_dnmt3a_mut$cell_type == "CD14+ Monocytes" & veh_complete_dnmt3a_mut$Clone != "Mutant"] = "Nonmutant CD14+ Monocytes"

veh_complete_tet2_mut_cc = create_cc(veh_complete_tet2_mut, output_path = "rds_objects/veh_complete_tet2_mut_cc.rds")
veh_complete_dnmt3a_mut_cc = create_cc(veh_complete_dnmt3a_mut, output_path = "rds_objects/veh_complete_dnmt3a_mut_cc.rds")
veh_complete_control_cc = create_cc(veh_complete_control, output_path = "rds_objects/veh_complete_control_cc.rds")

```



```{r}
veh_complete_control_cc = readRDS("rds_objects/cellchat/veh_complete_control_cc.rds")
veh_complete_tet2_mut_cc = readRDS("rds_objects/cellchat/veh_complete_tet2_mut_cc.rds")
veh_complete_dnmt3a_mut_cc = readRDS("rds_objects/cellchat/veh_complete_dnmt3a_mut_cc.rds")
```


```{r}
tet2_cc_mut.list = list(TET2 = veh_complete_tet2_mut_cc, Control = veh_complete_control_cc)
tet2_merged_cc_mut = mergeCellChat(tet2_cc_mut.list, add.names = names(tet2_cc_mut.list))
tet2_merged_cc_mut = updateCellChat(tet2_merged_cc_mut)

dnmt3a_cc_mut.list = list(DNMT3A = veh_complete_dnmt3a_mut_cc, Control = veh_complete_control_cc)
dnmt3a_merged_cc_mut = mergeCellChat(dnmt3a_cc_mut.list, add.names = names(dnmt3a_cc_mut.list))
dnmt3a_merged_cc_mut = updateCellChat(dnmt3a_merged_cc_mut)

```


# Save interaction values.
```{r}
(tet2_cd14_cc_mut_all = rankNet(tet2_merged_cc_mut, mode = "comparison", sources.use = c("CD14+ Monocytes"), do.stat = TRUE))
(dnmt3a_cd14_cc_mut_all = rankNet(dnmt3a_merged_cc_mut, mode = "comparison", sources.use = c("CD14+ Monocytes"), do.stat = TRUE))

write_tsv(tet2_cd14_cc_mut_all$data, "tables/cellchat/tet2_cd14_cc_mut_all.tsv")
write_tsv(dnmt3a_cd14_cc_mut_all$data, "tables/cellchat/dnmt3a_cd14_cc_mut_all.tsv")

```

# Make heat plots.
```{r}
make_heat_plot = function(heat, sample_genotype) {
  heat = heat %>%
    rowwise() %>%
    mutate(name = paste0(name, ifelse(pvalues < 0.05, "*", "")))
  ggplot(heat, aes(name, group, fill = contribution.scaled)) + 
  geom_tile() + 
  scale_fill_gradient(low = ifelse(sample_genotype == "TET2", brewer.pal(6, "Paired")[3], brewer.pal(6, "Paired")[5]), 
                      high = ifelse(sample_genotype == "TET2", brewer.pal(6, "Paired")[4], brewer.pal(6, "Paired")[6]),
                      breaks = c(min(heat$contribution.scaled), max(heat$contribution.scaled)),
                      labels = c("Low","High")) +  
  xlab("") +
  ylab("") +
  ggtitle("Outgoing mutant CD14+ monocyte signaling") + 
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank())
}

(tet2_cd14_heat = make_heat_plot(tet2_cd14_cc_mut_bar$data, "TET2"))
(dnmt3a_cd14_heat = make_heat_plot(dnmt3a_cd14_cc_mut_bar$data, "DNMT3A"))
 
save_plot(tet2_cd14_heat, "figures/cellchat/mut_tet2_cd14_heat", height = 2, width = 6)
save_plot(dnmt3a_cd14_heat, "figures/cellchat/mut_dnmt3a_cd14_heat", height = 2, width = 6)

```
